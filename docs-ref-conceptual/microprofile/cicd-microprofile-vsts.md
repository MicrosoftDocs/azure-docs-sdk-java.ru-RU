---
title: CI/CD для приложений MicroProfile с использованием Azure DevOps
description: Узнайте, как настроить цикл выпуска CI/CD для развертывания приложений MicroProfile в экземпляре Веб-приложения для контейнеров Azure с помощью Azure DevOps
services: Azure DevOps
documentationcenter: MicroProfile
author: ruyakubu
manager: brunoborges
editor: ruyakubu
ms.assetid: ''
ms.author: ruyakubu
ms.date: 09/14/2018
ms.devlang: Java
ms.service: Azure DevOps
ms.tgt_pltfrm: multiple
ms.topic: tutorial
ms.workload: web
ms.openlocfilehash: 818e37291fa47f99cb161c63a86062bddbf6248c
ms.sourcegitcommit: 4d52e47073fb0b3ac40a2689daea186bad5b1ef5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/23/2018
ms.locfileid: "49799940"
---
# <a name="cicd-for-microprofile-applications-using-azure-devops"></a>CI/CD для приложений MicroProfile с использованием Azure DevOps

В этом руководстве объясняется, как разработчики Java EE могут легко настроить цикл выпуска CI/CD, чтобы развернуть приложение [MicroProfile](http://microprofile.io) в экземпляре Веб-приложения для контейнеров Azure с помощью Azure DevOps (прежнее название — VSTS).  В этом примере мы будем использовать приложение MicroProfile, использующее [Payara Micro](https://www.payara.fish/payara_micro) в качестве базового образа.   

```Dockerfile
FROM payara/micro:5.182
COPY target/*.war $DEPLOY_DIR/ROOT.war
EXPOSE 8080
```
Мы начнем процесс контейнеризации в Azure DevOps с создания образа Docker, а затем отправим образ контейнера в Реестр контейнеров Azure.  После этого мы завершим работу с конвейером выпуска в Azure DevOps, чтобы развернуть образ контейнера в веб-приложении.

## <a name="prerequisites"></a>Предварительные требования
- Скопируйте и сохраните URL-адрес Git из [GitHub](https://github.com/Azure-Samples/microprofile-hello-azure).
- Регистрируйтесь или войдите в [Azure DevOps](https://dev.azure.com), используя учетную запись.
- Создайте [проект Azure DevOps](https://docs.microsoft.com/en-us/vsts/organizations/projects/create-project?view=vsts&tabs=new-nav) и **импортируйте репозиторий**, используя скопированный ранее URL-адрес Git.
- Создайте экземпляр службы [Реестр контейнеров Azure](https://azure.microsoft.com/en-us/services/container-registry) (ACR).
- Создайте экземпляр Веб-приложения для контейнеров Azure.
  > [!NOTE]
  >
  > При подготовке экземпляра веб-приложения выберите "Быстрый запуск" в разделе "Параметры контейнера".


## <a name="create-a-build-definition"></a>Создание определения сборки

Определение сборки в Azure DevOps обеспечивает автоматическое выполнение всех задач в сборке каждый раз, когда происходит фиксация в исходном приложении Java EE.  В этом примере для сборки проекта Java MicroProfile в Azure DevOps мы будем использовать Maven.

1. Перейдите на вкладку "Сборка и выпуск" в верхней части страницы проекта Azure DevOps.  Затем щелкните ссылку **Сборки**. 

<img src="media/VSTS/Buid-and-Release1.png">

2. Нажмите кнопку **Новый конвейер** и щелкните **Продолжить**, чтобы приступить к определению задач сборки.
3. В списке шаблонов выберите Maven и нажмите кнопку **Применить**, чтобы выполнить сборку проекта Java.
4. В раскрывающемся меню поля "Пул агентов" выберите параметр **Hosted Linux Preview** (Размещенная предварительная версия Linux).
   > [!NOTE]
   >
   > Таким образом, вы укажете Azure DevOps, какой сервер сборки использовать.  Можно использовать закрытый пользовательский сервер сборки.

5. Чтобы настроить сборку для непрерывной интеграции, перейдите на вкладку **Триггеры** и установите флажок **Включить непрерывную интеграцию**.  

<img src="media/VSTS/Build-Triggers2.png"> 

6. Выберите вкладку <strong>Задачи</strong>, чтобы вернуться на главную страницу конвейера сборки.
7. В раскрывающемся меню <strong>Сохранить и поместить в очередь</strong> выберите пункт <strong>Сохранить</strong>.


## <a name="create-a-docker-build-image"></a>Создание образа сборки Docker

В этой задаче для создания образа Docker в Azure DevOps используется файл Docker с базовым образом из Payara Micro.  

1. Выберите вкладку **Задачи**, чтобы вернуться на главную страницу конвейера сборки.
2. Щелкните значок **+**, чтобы добавить новую задачу в определение сборки.

<img src="media/VSTS/Tasks-add4.png">

3. В списке шаблонов выберите &quot;Docker&quot; и нажмите кнопку <strong>Добавить</strong>.
4. Введите описательное имя в поле <strong>Отображаемое имя</strong>.
5. Убедитесь, что в раскрывающемся меню для поля <strong>Тип реестра контейнеров</strong> выбран пункт <strong>Реестр контейнеров Azure</strong>.
&gt; [!NOTE]
&gt; &gt; Если вы используете Docker Hub или другой реестр, выберите &quot;Реестр контейнеров&quot;.  Нажмите кнопку &quot;+ Создать&quot;, чтобы указать учетные данные и данные подключения для этого реестра. Затем перейдите к разделу "Команды", чтобы продолжить.

6. В раскрывающемся меню **Подписка Azure** выберите идентификатор своей подписки.  Нажмите кнопку **Авторизовать**.
7. В раскрывающемся меню **Реестр контейнеров Azure** выберите имя реестра, который вы создали в Azure.
8. Убедитесь, что в раскрывающемся меню **Команда** выбран пункт **Сборка**.
9. Рядом с текстовым полем **Файл Docker** щелкните значок навигации для выбора пути, чтобы выбрать файл Docker в проекте GitHub.  Затем нажмите кнопку **ОК**.

<img src="media/VSTS/Dockerfile5.png">

10. Под полем **Имя образа** установите флажок **Включить последний тег**. 
11. В раскрывающемся меню **Сохранить и поместить в очередь** выберите пункт **Сохранить**.

## <a name="push-docker-image-to-acr"></a>Отправка образа Docker в ACR

В этой задаче Azure DevOps отправит образ Docker в Реестр контейнеров Azure.  Этот образ будет использоваться для запуска приложения API MicroProfile в качестве контейнерного веб-приложения Java.

1. Так как мы используем Docker в Azure DevOps, создайте новый шаблон Docker, повторив шаги 1–7, приведенные в разделе **Создание образа сборки Docker**.
2. В раскрывающемся меню **Команда** выберите **Отправить**.
3. Перейдите на вкладку **Сохранить и поместить в очередь** и выберите пункт **Сохранить и поместить в очередь**.
4. Убедитесь, что во всплывающем окне для пула агентов выбрано значение **Hosted Linux Preview** (Размещенная предварительная версия Linux).  Нажмите кнопку **Сохранить и поместить в очередь**.
5. Щелкните номер сборки, чтобы проверить, успешно ли завершен конвейер сборки для проекта Java.

<img src="media/VSTS/Build-Number6.png">


## <a name="create-a-release-definition-for-a-java-app"></a>Создание определения выпуска для приложения Java

Конвейер выпуска в Azure DevOps автоматически активирует развертывание артефактов сборки в целевую среду, например Azure, как только процесс сборки успешно завершится.   Конвейер выпуска можно создавать для сред разработки, тестирования, промежуточной или рабочей среды.

1. Перейдите на вкладку "Сборка и выпуск" в верхней части страницы проекта Azure DevOps.  Щелкните ссылку **Выпуски**.

<img src="media/VSTS/Release-new-pipeline7.png">

2. Нажмите кнопку &quot;Новый конвейер**.
3. В списке шаблонов выберите <strong>Развертывание приложения Java в службе приложений Azure</strong>, а затем нажмите кнопку <strong>Применить</strong>.

<img src="media/VSTS/deploy-java-template8.png">

4. Укажите <strong>имя этапа</strong> (например, разработки, тестирования или промежуточного этапа).  Нажмите кнопку <strong>X</strong>, чтобы закрыть всплывающее окно.
5. В разделе артефактов нажмите кнопку <strong>+Добавить</strong>.  Таким образом, вы свяжете артефакты из определения сборки с артефактами из этого определения выпуска.<br/>6. В раскрывающемся меню для поля <strong>Источник (конвейер сборки)</strong> выберите определение сборки. Нажмите кнопку <strong>Добавить</strong>, чтобы продолжить.

<img src="media/VSTS/add-artifact9.png">

7. Перейдите на вкладку <strong>Задачи</strong> на странице конвейера.  Выберите имя этапа.

<img src="media/VSTS/release-stage10.png">

8. В раскрывающемся меню **Подписка Azure** выберите идентификатор своей подписки.
9. Выберите тип **Приложение Linux** в раскрывающемся меню **Тип приложения**.
10. В раскрывающемся меню **Имя службы приложений** выберите имя созданного ранее экземпляра службы "Веб-приложение для контейнеров".
11. Введите имя экземпляра службы "Реестр контейнеров Azure" в поле **Registry or Namespaces** (Реестр или пространства имен).  Например, **myregistry.azure.io**.
12. Введите имя реестра в поле **Репозиторий**.
13. Щелкните **Deploy Azure App Service** (Развернуть службу приложений Azure).  Введите тег для образа контейнера в текстовом поле **Тег**. 
14. Щелкните **Запуск на агенте**.  В раскрывающемся меню пула агента выберите **Hosted Linux Preview** (Размещенная предварительная версия Linux). 

## <a name="setup-environment-variables"></a>Настройка переменных среды

1. Перейдите на вкладку **Переменные**.  Нажмите кнопку **+Добавить**, чтобы определить переменные среды.
2. Добавьте имя переменной и значения для URL-адреса реестра контейнеров, имя пользователя и пароля.   В целях безопасности щелкните значок замка, чтобы скрыть значение пароля.

Например: 
- registry.password;
- registry.url;
- registry.username.

<img src="media/VSTS/environment-variables12.png">

3. Щелкните вкладку **Задачи**, чтобы вернуться на главную страницу определения конвейера выпуска.
4. Щелкните **Deploy Azure App Service** (Развернуть службу приложений Azure). 
5. Разверните раздел **Параметры приложения и конфигурации**, щелкните значок навигации для выбора пути в поле **Параметры приложения**, чтобы добавить переменную среды для подключения к реестру контейнеров во время развертывания.
6. Нажмите кнопку **+Добавить**, чтобы определить следующие параметры приложения и присвоить переменные среды.
7. DOCKER_REGISTRY_SERVER_PASSWORD = $(registry.password).
8. DOCKER_REGISTRY_SERVER_URL = $(registry.url).
9. DOCKER_REGISTRY_SERVER_USERNAME = $(registry.username).

<img src="media/VSTS/environment-variables14.png">

7. Нажмите кнопку <strong>ОК</strong>, чтобы продолжить.

## <a name="setup-continious-deployment--deploy-java-application"></a>Настройка непрерывного развертывания и развертывание приложения Java

1. Чтобы включить непрерывное развертывание, перейдите на вкладку **Конвейеры**.
2. В разделе "Артефакты" щелкните значок с молнией.  Затем задайте для параметра **Триггер непрерывного развертывания** значение "Вкл.".

<img src="media/VSTS/release-enable-CD.png">

3. Последовательно нажмите кнопки <strong>Сохранить</strong> и <strong>ОК</strong>. 
4. Щелкните стрелку раскрывающегося меню <strong>+Выпуск</strong> и выберите ссылку <strong>Создать выпуск</strong>.
5. В раскрывающемся меню <strong>Stages for a trigger change from automated to manual</strong> (Этапы для изменения автоматической активации на активацию вручную) установите флажок рядом с вашим именем этапа.
6. Нажмите кнопку <strong>Создать</strong>, чтобы продолжить.
7. Щелкните номер выпуска.  Затем наведите указатель мыши на имя этапа и нажмите кнопку <strong>Развернуть</strong>.
8. Затем нажмите кнопку <strong>Развернуть</strong> во всплывающем окне, чтобы запустить развертывание в Azure.


## <a name="test-the-java-web-application"></a>Тестирование веб-приложения Java
1. Укажите URL-адрес веб-приложения в адресной строке веб-браузера:  
   https://{имя-экземпляра-службы-приложений}.azurewebsites.net/api/hello


<img src="media/VSTS/web-app16.png">

2. На веб-странице должно отобразится **Hello Azure!**

<img src="media/VSTS/web-api17.png">
