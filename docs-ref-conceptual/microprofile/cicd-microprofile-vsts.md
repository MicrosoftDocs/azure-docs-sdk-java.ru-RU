---
title: CI/CD для приложений MicroProfile с использованием Azure DevOps
description: Узнайте, как настроить цикл выпуска CI/CD для развертывания приложений MicroProfile в экземпляре Веб-приложения для контейнеров Azure с помощью Azure DevOps
services: Azure DevOps
documentationcenter: MicroProfile
author: ruyakubu
manager: brunoborges
editor: ruyakubu
ms.assetid: ''
ms.author: ruyakubu
ms.date: 09/14/2018
ms.devlang: Java
ms.service: Azure DevOps
ms.tgt_pltfrm: multiple
ms.topic: tutorial
ms.workload: web
ms.openlocfilehash: c2b6bf3370982d26d8d23fede370e0105a70b734
ms.sourcegitcommit: fd67d4088be2cad01c642b9ecf3f9475d9cb4f3c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/21/2018
ms.locfileid: "46506589"
---
# <a name="cicd-for-microprofile-applications-using-azure-devops"></a>CI/CD для приложений MicroProfile с использованием Azure DevOps

В этом руководстве объясняется, как разработчики Java EE могут легко настроить цикл выпуска CI/CD, чтобы развернуть приложение [MicroProfile](http://microprofile.io) в экземпляре Веб-приложения для контейнеров Azure с помощью Azure DevOps (прежнее название — VSTS).  В этом примере мы будем использовать приложение MicroProfile, использующее [Payara Micro](https://www.payara.fish/payara_micro) в качестве базового образа.   

```Dockerfile
FROM payara/micro:5.182
COPY target/*.war $DEPLOY_DIR/ROOT.war
EXPOSE 8080
```
Мы начнем процесс контейнеризации в Azure DevOps с создания образа Docker, а затем отправим образ контейнера в Реестр контейнеров Azure.  После этого мы завершим работу с конвейером выпуска в Azure DevOps, чтобы развернуть образ контейнера в веб-приложении.

## <a name="prerequisites"></a>Предварительные требования
- Скопируйте и сохраните URL-адрес Git из [GitHub](https://github.com/Azure-Samples/microprofile-hello-azure).
- Регистрируйтесь или войдите в [Azure DevOps](https://dev.azure.com), используя учетную запись.
- Создайте [проект Azure DevOps](https://docs.microsoft.com/en-us/vsts/organizations/projects/create-project?view=vsts&tabs=new-nav) и **импортируйте репозиторий**, используя скопированный ранее URL-адрес Git.
- Создайте экземпляр службы [Реестр контейнеров Azure](https://azure.microsoft.com/en-us/services/container-registry) (ACR).
- Создайте экземпляр Веб-приложения для контейнеров Azure.
> [!NOTE]
>
> При подготовке экземпляра веб-приложения выберите "Быстрый запуск" в разделе "Параметры контейнера".


## <a name="create-a-build-definition"></a>Создание определения сборки

Определение сборки в Azure DevOps обеспечивает автоматическое выполнение всех задач в сборке каждый раз, когда происходит фиксация в исходном приложении Java EE.  В этом примере для сборки проекта Java MicroProfile в Azure DevOps мы будем использовать Maven.

1. Перейдите на вкладку "Сборка и выпуск" в верхней части страницы проекта Azure DevOps.  Затем щелкните ссылку **Сборки**. 

<img src="media/VSTS/Buid-and-Release1.png">

2. Нажмите кнопку **Новый конвейер** и щелкните **Продолжить**, чтобы приступить к определению задач сборки.
3. В списке шаблонов выберите Maven и нажмите кнопку **Применить**, чтобы выполнить сборку проекта Java.
4. В раскрывающемся меню поля "Пул агентов" выберите параметр **Hosted Linux Preview** (Размещенная предварительная версия Linux).
> [!NOTE]
>
> Таким образом, вы укажете Azure DevOps, какой сервер сборки использовать.  Можно использовать закрытый пользовательский сервер сборки.

5. Чтобы настроить сборку для непрерывной интеграции, перейдите на вкладку **Триггеры** и установите флажок **Включить непрерывную интеграцию**.  

<img src="media/VSTS/Build-Triggers2.png"> 
 
6. Выберите вкладку **Задачи**, чтобы вернуться на главную страницу конвейера сборки.
7. В раскрывающемся меню **Сохранить и поместить в очередь** выберите пункт **Сохранить**.
 

## <a name="create-a-docker-build-image"></a>Создание образа сборки Docker

В этой задаче для создания образа Docker в Azure DevOps используется файл Docker с базовым образом из Payara Micro.  

1. Выберите вкладку **Задачи**, чтобы вернуться на главную страницу конвейера сборки.
2. Щелкните значок **+**, чтобы добавить новую задачу в определение сборки.
 
<img src="media/VSTS/Tasks-add4.png">
 
3. В списке шаблонов выберите Docker и нажмите кнопку **Добавить**.
4. Введите описательное имя в поле **Отображаемое имя**.
5. Убедитесь, что в раскрывающемся меню для поля **Тип реестра контейнеров** выбран пункт **Реестр контейнеров Azure**.
> [!NOTE]
>
>  Если вы используете Docker Hub или другой реестр, выберите "Реестр контейнеров".  Нажмите кнопку "+Создать", чтобы указать учетные данные и данные подключения для этого реестра. Затем перейдите к разделу "Команды", чтобы продолжить.

6. В раскрывающемся меню **Подписка Azure** выберите идентификатор своей подписки.  Нажмите кнопку **Авторизовать**.
7. В раскрывающемся меню **Реестр контейнеров Azure** выберите имя реестра, который вы создали в Azure.
8. Убедитесь, что в раскрывающемся меню **Команда** выбран пункт **Сборка**.
9. Рядом с текстовым полем **Файл Docker** щелкните значок навигации для выбора пути, чтобы выбрать файл Docker в проекте GitHub.  Затем нажмите кнопку **ОК**.

<img src="media/VSTS/Dockerfile5.png">

10. Под полем **Имя образа** установите флажок **Включить последний тег**. 
11. В раскрывающемся меню **Сохранить и поместить в очередь** выберите пункт **Сохранить**.

## <a name="push-docker-image-to-acr"></a>Отправка образа Docker в ACR

В этой задаче Azure DevOps отправит образ Docker в Реестр контейнеров Azure.  Этот образ будет использоваться для запуска приложения API MicroProfile в качестве контейнерного веб-приложения Java.

1. Так как мы используем Docker в Azure DevOps, создайте новый шаблон Docker, повторив шаги 1–7, приведенные в разделе **Создание образа сборки Docker**.
2. В раскрывающемся меню **Команда** выберите **Отправить**.
3. Перейдите на вкладку **Сохранить и поместить в очередь** и выберите пункт **Сохранить и поместить в очередь**.
4. Убедитесь, что во всплывающем окне для пула агентов выбрано значение **Hosted Linux Preview** (Размещенная предварительная версия Linux).  Нажмите кнопку **Сохранить и поместить в очередь**.
5. Щелкните номер сборки, чтобы проверить, успешно ли завершен конвейер сборки для проекта Java.

<img src="media/VSTS/Build-Number6.png">
 

## <a name="create-a-release-definition-for-a-java-app"></a>Создание определения выпуска для приложения Java

Конвейер выпуска в Azure DevOps автоматически активирует развертывание артефактов сборки в целевую среду, например Azure, как только процесс сборки успешно завершится.   Конвейер выпуска можно создавать для сред разработки, тестирования, промежуточной или рабочей среды.

1. Перейдите на вкладку "Сборка и выпуск" в верхней части страницы проекта Azure DevOps.  Щелкните ссылку **Выпуски**.

<img src="media/VSTS/Release-new-pipeline7.png">
 
2. Нажмите кнопку "Новый конвейер"**.
3. В списке шаблонов выберите **Развертывание приложения Java в службе приложений Azure**, а затем нажмите кнопку **Применить**.

<img src="media/VSTS/deploy-java-template8.png">
 
4. Укажите **имя этапа** (например, разработки, тестирования или промежуточного этапа).  Нажмите кнопку **X**, чтобы закрыть всплывающее окно.
5. В разделе артефактов нажмите кнопку **+Добавить**.  Таким образом, вы свяжете артефакты из определения сборки с артефактами из этого определения выпуска.  
6. В раскрывающемся меню для поля **Источник (конвейер сборки)** выберите определение сборки. Нажмите кнопку **Добавить**, чтобы продолжить.

<img src="media/VSTS/add-artifact9.png">
 
7. Перейдите на вкладку **Задачи** на странице конвейера.  Выберите имя этапа.
 
<img src="media/VSTS/release-stage10.png">

8. В раскрывающемся меню **Подписка Azure** выберите идентификатор своей подписки.
9. Выберите тип **Приложение Linux** в раскрывающемся меню **Тип приложения**.
10. В раскрывающемся меню **Имя службы приложений** выберите имя созданного ранее экземпляра службы "Веб-приложение для контейнеров".
11. Введите имя экземпляра службы "Реестр контейнеров Azure" в поле **Registry or Namespaces** (Реестр или пространства имен).  Например, **myregistry.azure.io**.
12. Введите имя реестра в поле **Репозиторий**.
13. Щелкните **Deploy Azure App Service** (Развернуть службу приложений Azure).  Введите тег для образа контейнера в текстовом поле **Тег**. 
14. Щелкните **Запуск на агенте**.  В раскрывающемся меню пула агента выберите **Hosted Linux Preview** (Размещенная предварительная версия Linux). 

## <a name="setup-environment-variables"></a>Настройка переменных среды

1. Перейдите на вкладку **Переменные**.  Нажмите кнопку **+Добавить**, чтобы определить переменные среды.
2. Добавьте имя переменной и значения для URL-адреса реестра контейнеров, имя пользователя и пароля.   В целях безопасности щелкните значок замка, чтобы скрыть значение пароля.

Например: 
- registry.password;
- registry.url;
- registry.username.

<img src="media/VSTS/environment-variables12.png">

3. Щелкните вкладку **Задачи**, чтобы вернуться на главную страницу определения конвейера выпуска.
4. Щелкните **Deploy Azure App Service** (Развернуть службу приложений Azure). 
5. Разверните раздел **Параметры приложения и конфигурации**, щелкните значок навигации для выбора пути в поле **Параметры приложения**, чтобы добавить переменную среды для подключения к реестру контейнеров во время развертывания.
6. Нажмите кнопку **+Добавить**, чтобы определить следующие параметры приложения и присвоить переменные среды.
- DOCKER_REGISTRY_SERVER_PASSWORD = $(registry.password).
- DOCKER_REGISTRY_SERVER_URL = $(registry.url).
- DOCKER_REGISTRY_SERVER_USERNAME = $(registry.username).

<img src="media/VSTS/environment-variables14.png">
 
7. Нажмите кнопку **ОК**, чтобы продолжить.

## <a name="setup-continious-deployment--deploy-java-application"></a>Настройка непрерывного развертывания и развертывание приложения Java

1. Чтобы включить непрерывное развертывание, перейдите на вкладку **Конвейеры**.
2. В разделе "Артефакты" щелкните значок с молнией.  Затем задайте для параметра **Триггер непрерывного развертывания** значение "Вкл.".

<img src="media/VSTS/release-enable-CD.png">
 
3. Последовательно нажмите кнопки **Сохранить** и **ОК**. 
4. Щелкните стрелку раскрывающегося меню **+Выпуск** и выберите ссылку **Создать выпуск**.
5. В раскрывающемся меню **Stages for a trigger change from automated to manual** (Этапы для изменения автоматической активации на активацию вручную) установите флажок рядом с вашим именем этапа.
6. Нажмите кнопку **Создать**, чтобы продолжить.
7. Щелкните номер выпуска.  Затем наведите указатель мыши на имя этапа и нажмите кнопку **Развернуть**.
8. Затем нажмите кнопку **Развернуть** во всплывающем окне, чтобы запустить развертывание в Azure.


## <a name="test-the-java-web-application"></a>Тестирование веб-приложения Java
1. Укажите URL-адрес веб-приложения в адресной строке веб-браузера:  
https://{имя-экземпляра-службы-приложений}.azurewebsites.net/api/hello

 
<img src="media/VSTS/web-app16.png">

2. На веб-странице должно отобразится **Hello Azure!**
 
<img src="media/VSTS/web-api17.png">
